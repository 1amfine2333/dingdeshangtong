<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>计划单详情</title>
    <link rel="stylesheet" href="__TMPL__/public/assets/user/lib/weui/jquery-weui.css"/>
    <link rel="stylesheet" href="__TMPL__/public/assets/user/lib/weui/weui.min.css"/>
    <link rel="stylesheet" href="__TMPL__/public/assets/user/css/public.css?_=1"/>
    <link rel="stylesheet" href="__TMPL__/public/assets/user/css/style.css"/>
    <script type="text/javascript" src="__TMPL__/public/assets/user/lib/jq/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="__TMPL__/public/assets/user/lib/weui/jquery-weui.js"></script>
    <script type="text/javascript" src="__TMPL__/public/assets/user/js/v.min.js"></script>
    <script type="text/javascript" src="__TMPL__/public/assets/user/js/common.js"></script>
</head>
<style>
    body .weui-vcode-btn.getCode.active {
        color: #ccc;
    }

    body .weui-vcode-btn.getCode {
        color: #4c7db2;
    }

    body .weui-vcode-btn {
        font-size: 1rem;
    }

    .underline {
        text-decoration: underline;
    }

    body .weui-cell__hd {
        min-width: 120px;
    }

    body .btn2 {
        width: 85%;
        height: 2.5rem;
        line-height: 2.5rem;
        margin-top: 2rem;
        box-shadow: none;
    }

    .daohang {
        width: 30px;
        background: url(__TMPL__/public/assets/user/img/daohang.png) no-repeat right center;
        background-size: 20px;
    }
</style>
<body class="bgf7">
<section id="app" class="DetailSec">
    <div class="content" style="padding-bottom: 50px;">
        <div class="disbox tit">
            <div class="disflex">计划单号：{$data.number}</div>
            <div class="colorThem" v-cloak>{{status[type]}}</div>
        </div>
        <div class="tit dark">下单人信息</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="{$data.avatar||default=''}"
                         onerror="this.src='__TMPL__/public/assets/user/img/default.jpg'"
                         style="width: 3rem; height: 3rem; border-radius: 50%;" alt="">
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.nickname||default=''}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd" style="width: auto; min-width: auto;">
                    <img src="__TMPL__/public/assets/user/img/lxdh.png" class="icon2" alt="">
                </div>
                <div class="weui-cell__bd">联系电话</div>
                <div class="weui-cell__ft">{$data.user_mobile}</div>
            </div>
        </div>
        <div class="tit dark">工程信息</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/dwmc2.png" class="icon2" alt="">
                    单位名称
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.unit_name}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/gcmc.png" class="icon2" alt="">
                    工程名称
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.project_name}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/ywy.png" class="icon2" alt="">
                    业务人员
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.salesman}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/gcdz.png" class="icon2" alt="">
                    工程地址
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">
                    <div class="disbox">
                        <div class="disflex">{$data.project_address}</div>
                        <div style="margin-left: 10px;">
                            <a href="http://api.map.baidu.com/marker?title=工程地址&content={$data.project_address}&output=html&location={$data.longitude_and_latitude}">
                                <img src="__TMPL__/public/assets/user/img/daohang.png"
                                     style="width: 25px;margin-top: 8px;"/>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/xcfz2.png" class="icon2" alt="">
                    现场负责
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.principal}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/lxdh2.png" class="icon2" alt="">
                    联系电话
                </div>
                <div class="weui-cell__bd"></div>
                <a class="weui-cell__ft underline" href="tel:{$data.mobile}" style="color:#5075ff;">{$data.mobile}</a>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/xdsj.png" class="icon2" alt="">
                    下单时间
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{:date("Y-m-d H:i:s",$data.create_time)}</div>
            </div>
        </div>
        <div class="tit dark">计划单</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/jzfs.png" class="icon2" alt="">
                    浇筑方式
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.pouring_type}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/jzbw.png" class="icon2" alt="">
                    浇筑部位
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.pouring_part}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/jzbh.png" class="icon2" alt="">
                    浇筑标号
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.pouring_label}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/tld.png" class="icon2" alt="">
                    坍落度
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.slump}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/jhfl.png" class="icon2" alt="">
                    计划方量
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.plan_square}m³</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/styj2.png" class="icon2" alt="">
                    商砼运距
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.distance}Km</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/jzsj2.png" class="icon2" alt="">
                    浇筑时间
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{:date("Y-m-d H:i:s",$data.pouring_time)}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <img src="__TMPL__/public/assets/user/img/beizhu.png" class="icon2" alt="">
                    备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注
                </div>
                <div class="weui-cell__bd"></div>
                <div class="weui-cell__ft">{$data.remark|default='暂无备注'}</div>
            </div>
        </div>


        <if condition="$data['status']==1 && $data['isLogin']">
            <div class="weui-flex" v-show="type==1">
                <div class="weui-flex__item">
                    <div class="placeholder btn2" @click="action({$data.id},2)">处理</div>
                </div>
                <div class="weui-flex__item">
                    <div class="placeholder btn2 circle" @click="action({$data.id},3)">拒绝</div>
                </div>
                <div class="weui-flex__item">
                    <div class="placeholder btn2 circle" @click="action({$data.id},4)">取消</div>
                </div>
            </div>
        </if>


    </div>
</section>
</body>
</html>
<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script>

    var app = new Vue({
        el: '#app',
        data: {
            type: '{$data.status}',    //当前的状态（0.全部，1.待处理，2.已处理，3.已拒绝，4.已取消）
            status: ['全部', '待处理', '已接单', '已拒绝', '已取消'],
            content: '',     //反馈文本
            words: 300,    //可输入字数
        },
        methods: {
            //点击取消
            cancelFn: function (id) {
                $.confirm({
                    title: '提示',
                    text: '确认取消计划单？',
                    onOK: function () {
                        //点击确认
                        if (id) {
                            request({
                                url: "{:url('plan/cancel')}",
                                data: {id: id},
                                success: function (resule) {
                                    if (resule.code) {
                                        setTimeout(function () {
                                            location.reload()
                                        }, 600)
                                    }
                                    setTimeout(function () {
                                        resule.msg && $.toast(resule.msg, resule.code ? "" : 'cancel')
                                    }, 100)
                                }
                            })
                        }
                    },
                    onCancel: function () {
                    }
                });
            },
            //点击提交
            upFn: function (evt) {
                var self = this;
                if (self.content.length < 1) {
                    $.toast("请输入反馈内容", "cancel");
                    return
                }
                $.confirm({
                    title: '提示',
                    text: '确认提交反馈吗？',
                    onOK: function () {
                        request({
                            url: "{:url('complaint/addPost')}",
                            data: {content: self.content, plan_number: '{$data.number}', type: 3},
                            success: function (resule) {
                                if (resule.code) {
                                    setTimeout(function () {
                                        location.reload()
                                    }, 600)
                                }
                                setTimeout(function () {
                                    resule.msg && $.toast(resule.msg, resule.code ? "" : 'cancel')
                                }, 100)
                            }
                        })
                        //点击确认
                    },
                    onCancel: function () {

                    }
                });
            }
        },
        watch: {
            backtext: function (val) {
                app.words = 300 - val.length;
            }
        }
    });

    //操作计划单
    function action(id, type) {

        let status = ["", "", '安排', '拒绝', '取消'];
        $.confirm({
            title: '提示',
            text: '确认' + status[type] + '计划单？',
            onOK: function () {
                //点击确认
                if (id) {
                    request({
                        url: "{:url('plan/edit')}",
                        data: {id: id, status: type}
                    })
                }
            },
            onCancel: function () {
            }
        });
    }

    $(function () {
        // 3. 通过config接口注入权限验证配置
        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId:    "<?php echo $signPackage['appId'];?>", // 必填，公众号的唯一标识
            timestamp:Number('{$signPackage.timestamp}'), // 必填，生成签名的时间戳
            nonceStr: "<?php echo $signPackage['nonceStr'];?>", // 必填，生成签名的随机串
            signature:"<?php echo $signPackage['signature'];?>", // 必填，签名，见附录1
            jsApiList: [
               "updateAppMessageShareData",
                "updateTimelineShareData",
                "onMenuShareTimeline",
                'onMenuShareAppMessage'
            ]
        });

        var desc ="业务人员:{$data.salesman} 商砼运距:{$data.distance}Km 工程地址:{$data.project_address}";
        var link = location.toString();
        var title = '{$data.project_name}';
        var imgUrl = 'http://{$Think.server.http_host}__TMPL__/public/assets/user/img/share_logo.jpg';

        // 5. 通过error接口处理失败验证
        wx.error(function (res) {
            // alert(JSON.stringify(res))
        });

        wx.ready(function () {   //需在用户可能点击分享按钮前就先调用

            wx.updateTimelineShareData({
                title: title, // 分享标题
                link: link , // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: imgUrl, // 分享图标
                success: function () {
                    // 设置成功
                }
            });

            wx.updateAppMessageShareData({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: imgUrl, // 分享图标
                success: function () {
                    // 设置成功
                }
            });

        });


    })
</script>





